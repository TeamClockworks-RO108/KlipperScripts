







[gcode_macro STATUS_LED]

# Name of the LED strip to use as status LED
variable_led_name: status_led

# If your led has no W channel, set this to true to decompose white into RGB
variable_led_decompose_white: false

# How many LEDS to skip in the chain (used for other purposes)
# And how many LEDS to write to in the chain
variable_led_offset: 2
variable_led_count: 1

# Define which color scheme do you want to use for each action
variable_color_idle: "green"
variable_color_printing: "red"
variable_color_paused: "orange"
variable_color_loading: "purple"
variable_color_purging: "blinking purple"
variable_color_unloading: "purple"
variable_color_error: "blue"

gcode:
    {% set cmap = printer["gcode_macro _COLOR_MAP"].colors %}
    {% set req_status = params.STATUS|default("clear")|lower %}
    {% set status_color_map = {
        "idle": color_idle,
        "printing": color_printing,
        "paused": color_paused,
        "loading": color_loading,
        "unloading": color_unloading,
        "error": color_error,
        "purging": color_purging
    } %}

    # Handle "blinking <color>" (blinking not actually implemented yet)
    {% set blinking = false %}
    {% if " " in req_status %}
        {% set tokens = color_name.split(" ", 1) %}
        {% if tokens[0] == "blinking" %}
            {% set blinking = true %}
            {% set req_status = tokens[1] %}
        {% endif %}
    {% endif %}

    # Determine effective status / color name
    {% if req_status in status_color_map %}
        {% set color_name = status_color_map[req_status] %}
    {% elif req_status == "clear" %}
        # Auto-deduce from printer status: printing / paused / idle
        {% set ps = printer.print_stats.state|lower %}
        {% if ps == "printing" %}
            {% set auto_status = "printing" %}
        {% elif ps == "paused" %}
            {% set auto_status = "paused" %}
        {% else %}
            {% set auto_status = "idle" %}
        {% endif %}
        {% set color_name = status_color_map[auto_status] %}
    {% elif req_status in cmap %}
        # Allow direct color name (e.g. STATUS=purple)
        {% set color_name = req_status %}
    {% else %}
        RESPOND TYPE=error MSG="Unknown color or status {req_status}"
    {% endif %}

    # Lookup color in cmap, default to black if unknown
    {% if color_name in cmap %}
        {% set base = cmap[color_name] %}
    {% else %}
        RESPOND TYPE=error MSG="Unknown color {color_name} configured for status {req_status}"
    {% endif %}

    {% set r = base.r|float %}
    {% set g = base.g|float %}
    {% set b = base.b|float %}
    {% set w = base.w|float %}

    # If led_decompose_white: add W into RGB and clamp to 1.0
    {% if led_decompose_white and w > 0 %}
        {% set r = (r + w) if r + w <= 1.0 else 1.0 %}
        {% set g = (g + w) if g + w <= 1.0 else 1.0 %}
        {% set b = (b + w) if b + w <= 1.0 else 1.0 %}
        {% set w = 0.0 %}
    {% endif %}

    # Apply color to the configured range of LEDs
    {% for i in range(led_count) %}
        {% if i + 1 == led_count %}
            SET_LED LED={led_name} RED={r} GREEN={g} BLUE={b} WHITE={w} INDEX={led_offset + i} TRANSMIT=1
        {% else %}
            SET_LED LED={led_name} RED={r} GREEN={g} BLUE={b} WHITE={w} INDEX={led_offset + i} TRANSMIT=0
        {% endif %}
    {% endfor %}




[gcode_macro _COLOR_MAP]
variable_colors: {
    "red":    {"r":1.0, "g":0.0, "b":0.0, "w":0.0},
    "green":  {"r":0.0, "g":1.0, "b":0.0, "w":0.0},
    "blue":   {"r":0.0, "g":0.0, "b":1.0, "w":0.0},
    "white":  {"r":0.0, "g":0.0, "b":0.0, "w":1.0},

    "yellow": {"r":1.0, "g":1.0, "b":0.0, "w":0.0},
    "cyan":   {"r":0.0, "g":1.0, "b":1.0, "w":0.0},
    "magenta":{"r":1.0, "g":0.0, "b":1.0, "w":0.0},

    "orange": {"r":1.0, "g":0.5, "b":0.0, "w":0.0},
    "purple": {"r":0.6, "g":0.0, "b":0.6, "w":0.0},
    "pink":   {"r":1.0, "g":0.4, "b":0.7, "w":0.0},

    "black":  {"r":0.0, "g":0.0, "b":0.0, "w":0.0}
}
gcode:
