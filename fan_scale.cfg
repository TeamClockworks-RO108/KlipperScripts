[gcode_macro M106]
description: Override M106 with scale/offset and optional override
rename_existing: M106_BASE

# How much to scale the value
variable_scale: 1.0

# Any offset to add to the fan, after the value is scaled.
variable_offset: 0.0

# Used at runtime to provide override.
# DO NOT MODIFY
variable_override_active: 0
variable_override_value: 0.0


gcode:
  {% set s_raw = params.S|default(255)|int %}

  {% if s_raw <= 0 %}
    M107
  {% else %}
    {% set s_norm = s_raw / 255.0 %}

    {% if override_active %}
      {% set s_eff = override_value %}
    {% else %}
      {% set s_eff = (s_norm * scale) + offset %}
    {% endif %}

    {% if s_eff < 0.0 %}
      {% set s_eff = 0.0 %}
    {% endif %}
    {% if s_eff > 1.0 %}
      {% set s_eff = 1.0 %}
    {% endif %}

    M106 S{s_eff * 255.0}
  {% endif %}


  [gcode_macro TEST_FAN_TUNING]
description: Live fan tuning and override control
gcode:
  {% if 'SCALE' in params %}
    SET_GCODE_VARIABLE MACRO=M106 VARIABLE=scale VALUE={params.SCALE|float}
  {% endif %}

  {% if 'OFFSET' in params %}
    SET_GCODE_VARIABLE MACRO=M106 VARIABLE=offset VALUE={params.OFFSET|float}
  {% endif %}

  {% if 'OVERRIDE' in params %}
    {% set ov = params.OVERRIDE|float %}
    {% if ov < 0.0 %}{% set ov = 0.0 %}{% endif %}
    {% if ov > 1.0 %}{% set ov = 1.0 %}{% endif %}
    SET_GCODE_VARIABLE MACRO=M106 VARIABLE=override_value VALUE={ov}
    SET_GCODE_VARIABLE MACRO=M106 VARIABLE=override_active VALUE=1
  {% else %}
    SET_GCODE_VARIABLE MACRO=M106 VARIABLE=override_active VALUE=0
  {% endif %}
